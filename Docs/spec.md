# LaValorant_dev_spec.md

## 0. ドキュメント情報

| バージョン | 日付 | 作成者 | 概要 |
| :--- | :--- | :--- | :--- |
| 2.0 | 2025/07/07 | 仕様書作成 | 専門家のレビューに基づき、非機能要件、セキュリティ、運用・保守、テスト仕様を大幅に拡充 |
| 1.3 | 2025/07/07 | 仕様書作成 | DB設計、編集制限、バリデーションルールを追記 |
| 1.2 | 2025/07/07 | 仕様書作成 | ユーザーフィードバックに基づき、仕様の明確化、DB設計の修正、非機能要件の補足を実施 |
| 1.1 | 2025/07/07 | 仕様書作成 | データベース設計に`participants`テーブルを追加 |
| 1.0 | 2025/07/07 | 仕様書作成 | 初版作成 |

---

## 1. 概要

### 1.1. プロジェクト名
LaValorant_dev

### 1.2. Bot名
LaValorant

### 1.3. 目的
ゲーム「VALORANT」のプレイヤーが、Discordサーバー上で円滑に参加者を募集し、活動状況に基づいたコミュニティの活性化を促進することを目的とする。また、Riot Games APIと連携し、ユーザーのランク情報を可視化することで、より質の高いマッチング体験を提供する。

### 1.4. 技術スタック
| カテゴリ | 技術 | 備考 |
| :--- | :--- | :--- |
| データベース | Supabase | ユーザー情報、募集情報、活動履歴等を永続化 |
| ホスティング環境 | Heroku | Bot本体及び認証用Webサーバーのホスティング |
| 設定管理 | 環境変数 | Discord Token, Riot API Key, DB接続情報等を管理 |

---

## 2. 機能要件

### 2.1. コマンド一覧
| コマンド | 説明 | 利用権限 |
| :--- | :--- | :--- |
| `/joinus` | 参加者募集を開始する | 全員 |
| `/cancel` | 自身が開始した募集をキャンセルする | 全員 |
| `/edit` | 自身が開始した募集内容を編集する | 全員 |
| `/rank` | Valorantアカウントを連携し、ランク情報を管理する | 全員 |
| `/help` | Botのコマンド一覧や使い方を表示する | 全員 |

### 2.2. `/joinus` (募集開始)
ユーザーが募集を開始するための中心的な機能。

**フロー:**
1. **コマンド実行**: ユーザーは以下の形式でコマンドを実行する。
   - `/joinus [other_member_1: @ユーザー] [other_member_2: @ユーザー] ...`
   - `other_member`: 任意。他に確定しているメンバーをDiscordのユーザー選択UIで指定する。
2. **モーダル表示**: コマンド実行後、以下の項目を入力するモーダルが表示される。
   - **人数形態**: ドロップダウン (デュオ, トリオ, フルパ, カスタム)
   - **残り必要人数**: 数値入力 (例: `2`)
   - **募集締め切り時間**: テキスト入力 (例: `22:00`, `30分後`)
   - ※カスタム募集の詳細オプション（具体的な人数指定、マップ指定等）は将来の拡張範囲とする。
3. **内部処理**: Botは以下のメンバーを初期参加者として自動的にリストアップする。
   - 募集主 (コマンド実行者)
   - VC参加者 (コマンド実行時に募集主が接続しているボイスチャンネル内の全メンバー)
   - 手動追加メンバー (`other_member`で指定されたユーザー)
4. **募集開始**: 収集した情報を元に、指定された募集用チャンネルにEmbedメッセージを投稿し、募集を開始する。

**募集完了（〆）条件:**
- 募集メッセージのステータスは、以下のいずれかの条件を満たした時点で自動的に「〆」に更新される。
  - 参加者数が募集人数に達したとき（「残り人数」が0になったとき）。
  - 設定された「募集締め切り時間」を過ぎたとき。

### 2.3. `/cancel` (募集キャンセル)
募集主が自身の募集を途中で取りやめるための機能。
- **対象**: 自分が開始した、完了していない募集。
- **実行**:
  - 募集メッセージのEmbedが「この募集はキャンセルされました」という内容に更新され、参加ボタン等は無効化される。
  - その時点で参加していたユーザーに対し、DMで募集がキャンセルされた旨を通知する。

### 2.4. `/edit` (募集編集)
募集主が募集内容を修正するための機能。
- **対象**: 自身が開始した募集のうち、**ステータスが「募集中」であり、かつ締切時間前のもの**に限る。
- **実行**: `/joinus`と同様のモーダルが再度表示され、内容を修正できる。
- **編集可能項目**: 「人数形態」「残り必要人数」「募集締め切り時間」。

### 2.5. `/rank` (Valorant連携・ランク管理)
ユーザーのDiscordアカウントとRiotアカウントを紐付け、ランクに応じたロールを付与する機能。

**フロー:**
1. **コマンド実行**: ユーザーが`/rank`コマンドを実行。
2. **認証URL発行**: Botはユーザー専用のRiot OAuth 2.0認証URLを生成し、ユーザーのみが見られるメッセージで送信する。
3. **Riot認証**: ユーザーはURLからRiot Games公式サイトにアクセスし、ログインして「LaValorant」への情報提供を許可する。
4. **アカウント連携**: 認証成功後、RiotからBotのバックエンドサーバーにコールバックが送られる。Botは受け取った情報（Discord IDとRiot PUUID）をSupabaseデータベースに保存する。
5. **ランク取得・ロール付与**:
   - 連携完了後、定期実行処理（毎日AM9:00）により、Valorant APIから最新のランク情報を取得し、対応するDiscordロールを自動で付与・更新する。
   - **ランク取得失敗時の挙動**:
     - APIからのランク取得に失敗した場合、前回のランク情報を維持する。
     - 連続して3日間ランク取得に失敗した場合、対象ユーザーのランク関連ロールを一旦削除し、「ランク未設定」に相当する状態とする。

### 2.6. `/help` (ヘルプ表示)
Botの利用方法を案内する。
- **実行**: 全コマンドの機能説明を記載したEmbedメッセージを表示する。Embedには以下の内容を含む。
  - 各コマンドの構文と具体的な使い方例。
  - 募集への参加方法と、参加を取り消す方法。
  - `/rank` 連携時に発行される認証URLには有効期限がある旨の注意喚起。

### 2.7. 活動評価ロール機能
ユーザーのサーバー内での活動状況を評価し、特定のロールを付与する。

- **評価タイミング**: 毎日 AM9:00 (ランク更新と同時)
- **集計期間**: 常に実行日から遡って直近30日間
- **高参加率ロール (`レギュラーメンバー`)**:
  - **対象**: 集計期間内の募集への**参加回数が上位5名**のユーザー。
- **低参加率ロール (`幽霊部員`)**:
  - **対象**: 集計期間内の**不参加率が90%を超えている**ユーザー。
  - **不参加率の定義**: `リアクションしなかった募集数 ÷ 期間内の全募集数`

---

## 3. 画面・メッセージ仕様

### 3.1. 募集Embedメッセージ
募集チャンネルに投稿されるメッセージ。
- **動的更新**: ユーザーが「参加する」「参加を取り消す」ボタンを操作すると、メッセージ内の「残り人数」「参加者」リストがリアルタイムで更新される。
- **タイトル**: (例: `VALORANT @5 募集`)
- **フィールド**:
  - **ステータス**: 募集中 / 〆 / キャンセル
  - **募集主**: @ユーザー名
  - **人数形態**: (例: フルパ)
  - **残り人数**: (例: あと2人)
  - **参加者**: @ユーザーA, @ユーザーB, ...
  - **締切**: (例: 22:00)
- **コンポーネント (ボタン)**:
  - `参加する`
  - `参加を取り消す`

### 3.2. モーダルUI
`/joinus`, `/edit`で使用する入力フォーム。

| フィールド名 | UI種別 | 仕様詳細・バリデーションルール |
| :--- | :--- | :--- |
| **人数形態** | ドロップダウン | - 選択肢: `デュオ`, `トリオ`, `フルパ`, `カスタム` のいずれか必須。 |
| **残り必要人数** | テキスト入力 | - `0` 以上の整数値を入力する必要がある。 |
| **募集締め切り時間** | テキスト入力 | - 許容フォーマット: `HH:MM` (例: `22:00`), 相対時間 (例: `30m`, `1h`)。 <br> - 未来の時間を指定する必要がある。過去の時間はエラーとする。|

---

## 4. 外部連携

### 4.1. Discord API
Botの基本機能、スラッシュコマンド、モーダル、Embedメッセージ、ロール管理等、すべての操作で利用する。

### 4.2. Riot Games API
- **OAuth 2.0**: ユーザー認証とPUUIDの取得に利用。
- **VAL-RANKED-V1**: プレイヤーのランク情報取得に利用。

---

## 5. データベース設計 (Supabase)

### 5.1. `users` テーブル
ユーザーの基本情報とRiotアカウントとの連携情報を格納する。
| カラム名 | データ型 | 説明 | 主キー |
| :--- | :--- | :--- | :--- |
| `discord_id` | `varchar` | DiscordのユーザーID | PK |
| `riot_puuid` | `varchar` | Riot GamesのPUUID | |
| `riot_access_token` | `varchar` | Riot APIアクセストークン | |
| `riot_refresh_token` | `varchar` | Riot APIリフレッシュトークン | |
| `created_at` | `timestamp` | 作成日時 | |
| `updated_at` | `timestamp` | 更新日時 | |

### 5.2. `recruitments` テーブル
投稿された募集そのものの情報を格納する。
| カラム名 | データ型 | 説明 | 主キー |
| :--- | :--- | :--- | :--- |
| `id` | `uuid` | 募集ID | PK |
| `message_id` | `varchar` | DiscordのメッセージID | |
| `creator_id` | `varchar` | 募集主のDiscord ID | |
| `vc_channel_id`| `varchar` | 募集時に接続していたVCのID | |
| `party_type` | `varchar` | 人数形態 (duo, trio, full, custom) | |
| `max_participants` | `int` | 募集定員（例: 5） | |
| `needed_count` | `int` | 募集開始時の残り人数 | |
| `status` | `varchar` | 募集ステータス (open, closed, cancelled) | |
| `deadline` | `timestamp` | 募集締切日時 | |
| `created_at` | `timestamp` | 作成日時 | |

### 5.3. `participants` テーブル
「どの募集に」「どのユーザーが」参加しているか、という現在の**状態**を管理する中間テーブル。参加を取り消した場合、このテーブルから該当レコードは削除される。
| カラム名 | データ型 | 説明 | 主キー |
| :--- | :--- | :--- | :--- |
| `recruitment_id` | `uuid` | どの募集か (FK: `recruitments.id`) | PK, FK |
| `user_id` | `varchar` | どのユーザーか (Discord ID) | PK |
| `joined_at` | `timestamp` | 参加日時 | |

### 5.4. `activity_logs` テーブル
ユーザーの参加・取消といった行動の**履歴**をすべて記録するテーブル。活動評価ロールの計算に用いる。
| カラム名 | データ型 | 説明 | 主キー |
| :--- | :--- | :--- | :--- |
| `id` | `uuid` | ログID | PK |
| `user_id` | `varchar` | 行動したユーザーのDiscord ID | |
| `recruitment_id` | `uuid` | 対象の募集ID (FK) | |
| `action_type` | `varchar` | 行動タイプ (join, leave) | |
| `created_at` | `timestamp` | 行動日時 | |

---

## 6. 非機能要件

### 6.1. 権限管理
- 全コマンドはサーバーに参加しているすべてのユーザーが利用可能とする。特別なロール制限は設けない。

### 6.2. 定期実行処理 (バッチ処理)
- **実行時刻**: 毎日 AM9:00 JST
- **トリガー方法**: Heroku環境で運用する場合、**Heroku Scheduler**アドオンを利用して定期実行タスクをトリガーする。
- **処理内容**:
  1. 全連携ユーザーのValorantランクを更新し、ロールを再付与する。
  2. 全ユーザーの直近30日間の活動履歴を集計し、活動評価ロールを再付与する。

### 6.3. エラーハンドリング
- **コマンドエラー**: コマンドの実行に失敗した場合、実行したユーザーにのみ見える形でエラーメッセージ（例:「コマンドの処理中にエラーが発生しました」）を表示する。
- **APIレート制限**: Discord APIおよびRiot Games APIのレートリミットに達した場合、エクスポネンシャルバックオフアルゴリズムを用いてリトライを行う。複数回（例: 3回）失敗した場合は処理を中断し、エラーログを記録すると共に、ユーザーに時間をおいて再試行するよう通知する。
- **データベース接続エラー**: 起動時に接続できない場合はBotを終了させ、ログに致命的エラーを記録する。運用中の接続断については、再接続処理を試みる。失敗が続く場合はサービスを異常終了させ、プラットフォーム（Heroku）の再起動機構に委ねる。

### 6.4. パフォーマンス要件
- **コマンドレスポンス時間**: ユーザーがコマンドを実行してから、Botが最初の応答を返すまでの時間を原則として**3秒以内**とする。
- **同時処理可能な募集数**: システム全体で、アクティブな募集を最低**100件**は問題なく処理できること。

### 6.5. 可用性
- サービス稼働率は月間**99.5%**以上を目標とする。

### 6.6. スケーラビリティ
- サーバーのユーザー数や利用頻度の増加に対応するため、以下のスケーリング方針を定める。
  - **垂直スケール（スケールアップ）**: 負荷増大に応じて、HerokuのDynoタイプを上位プランに変更する。
  - **データベース**: Supabaseの利用状況に応じて、上位プランへアップグレードする。

---

## 7. セキュリティ要件

### 7.1. 入力値の処理
- **サニタイゼーション**: 全てのユーザー入力値は、データベースへの保存前、およびEmbedメッセージ等で表示する前に、SQLインジェクションやクロスサイトスクリプティング（XSS）を防ぐためのサニタイゼーション処理を必須とする。
- **バリデーション**: 入力値は、予期せぬ挙動を防ぐため、型、長さ、フォーマットを厳密に検証する。
  - 例：募集メッセージのテキストフィールドは100文字以内とする。

### 7.2. 機密情報の管理
- **設定情報**: Discord Bot Token, Riot API Key, Supabase接続情報などの機密情報は、HerokuのConfig Vars（環境変数）で管理する。コード内に直接記述しない。
- **トークンの暗号化**: データベースに保存するRiot APIのアクセストークンおよびリフレッシュトークンは、Supabaseの暗号化機能またはアプリケーションレベルでの暗号化を施し、平文で保存しない。

### 7.3. API利用制限
- Botから外部API（Discord, Riot Games）への呼び出し頻度を管理し、APIプロバイダの定めるレートリミットを遵守する。
- ユーザーからの過剰なコマンド実行を防ぐため、ユーザー単位でのコマンド実行頻度に制限（例: 10秒間に5回まで）を設け、超過した場合は一時的に応答を停止する。

---

## 8. 運用・保守要件

### 8.1. ロギング
- **ログレベル**: `INFO`, `WARN`, `ERROR`, `FATAL`のログレベルを定義する。
- **記録内容**: コマンド実行履歴、エラー情報、定期実行タスクの処理結果、外部APIとの通信内容などを記録する。
- **ログ保存期間**: ログは最低**30日間**保存する。

### 8.2. バックアップ戦略
- **データベース**: Supabaseの自動バックアップ機能を利用し、日次でデータベースのバックアップを取得する。バックアップデータは最低**14日間**保持する。

### 8.3. 障害復旧手順
- **障害検知**: Herokuのログ監視や、外部の死活監視サービスを用いて障害を検知する。
- **復旧手順**:
  1. ログを調査し、障害原因を特定する。
  2. 重大なバグが原因の場合、Herokuのリリース機能を用いて安定バージョンへロールバックする。
  3. 軽微な問題は、修正パッチをデプロイして対応する。
- **目標復旧時間 (RTO)**: 重大障害発生から**2時間以内**の復旧を目指す。

---

## 9. テスト仕様

### 9.1. 単体テスト (Unit Test)
- **対象**: 各コマンドの処理ロジック、外部APIクライアント、データベース操作を行う関数・モジュール。
- **方針**: 依存関係をモック化し、各ユニットが仕様通りに動作することを確認する。テストカバレッジは**70%**以上を目標とする。

### 9.2. 結合テスト (Integration Test)
- **対象**: 複数のモジュールが連携する一連のフロー。
- **観点**:
  - `/joinus`実行から募集メッセージ投稿、DBへの書き込みまで。
  - `/rank`実行からOAuthフローを経て、DBにユーザー情報が保存されるまで。
  - 参加ボタン押下から、DB更新とメッセージ編集が正しく行われるか。

### 9.3. E2Eテスト (End-to-End Test)
- **環境**: 本番環境とは別の、開発用Discordサーバーおよびテスト用DBを用いて実施する。
- **観点**: 実際のユーザーとしてBotを利用するシナリオを想定し、目的の機能が正しく動作するかを通しで確認する。